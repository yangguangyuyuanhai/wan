# 工业视觉系统 - 架构说明文档

## 📋 目录
1. [系统概述](#系统概述)
2. [架构设计](#架构设计)
3. [模块说明](#模块说明)
4. [使用方法](#使用方法)
5. [配置说明](#配置说明)
6. [开发指南](#开发指南)

---

## 🎯 系统概述

这是一个基于**管道-过滤器架构**的工业视觉系统，采用**微服务设计模式**，实现了相机图像采集、预处理、YOLO目标检测、OpenCV图像处理、实时显示和数据存储的完整流程。

### 核心特性

- ✅ **管道-过滤器架构** - 模块化、可扩展
- ✅ **微服务设计** - 每个功能独立服务
- ✅ **异步处理** - 高性能并发处理
- ✅ **配置化管理** - 灵活的配置系统
- ✅ **完整日志** - 详细的运行日志
- ✅ **性能监控** - 实时性能统计

---

## 🏗️ 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         Main.py                              │
│                        (上帝类)                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Scheduler (调度器)                      │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │           Pipeline (管道)                      │  │   │
│  │  │                                                 │  │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │   │
│  │  │  │ Camera   │→ │Preprocess│→ │  YOLO    │    │  │   │
│  │  │  │ Service  │  │ Service  │  │ Service  │    │  │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘    │  │   │
│  │  │       ↓              ↓              ↓         │  │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │   │
│  │  │  │ OpenCV   │→ │ Display  │→ │ Storage  │    │  │   │
│  │  │  │ Service  │  │ Service  │  │ Service  │    │  │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘    │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 数据流向

```
相机采集 → 图像预处理 → YOLO检测 → OpenCV处理 → 显示 → 存储
   ↓           ↓            ↓           ↓         ↓      ↓
DataPacket → DataPacket → DataPacket → DataPacket → ...
```

### 管道-过滤器模式

每个服务都是一个**过滤器（Filter）**：
- 接收输入数据包（DataPacket）
- 执行特定处理
- 输出处理后的数据包
- 可独立启用/禁用

---

## 📦 模块说明

### 1. 核心模块

#### main.py - 上帝类
**职责：** 系统入口，管理整个生命周期

**主要功能：**
- 加载配置
- 初始化系统
- 启动/停止系统
- 命令行参数解析

**关键类：**
```python
class VisionSystem:
    def load_config(mode)      # 加载配置
    def customize_config(**kwargs)  # 自定义配置
    def initialize()           # 初始化
    def start()                # 启动
    def run()                  # 运行
    def stop()                 # 停止
```

---

#### scheduler.py - 调度器
**职责：** 管理和调度管道系统

**主要功能：**
- 初始化所有服务
- 启动/停止管道
- 管理相机采集循环
- 性能监控

**关键类：**
```python
class PipelineScheduler:
    def initialize()           # 初始化管道
    def start()                # 启动系统
    def stop()                 # 停止系统
    def _camera_loop()         # 相机采集循环
```

---

#### pipeline_core.py - 管道核心
**职责：** 实现管道-过滤器架构

**关键类：**

**DataPacket - 数据包**
```python
@dataclass
class DataPacket:
    packet_id: int             # 唯一标识
    timestamp: float           # 时间戳
    image: Any                 # 原始图像
    processed_image: Any       # 处理后图像
    detections: list           # 检测结果
    processing_times: dict     # 处理时间
    metadata: dict             # 元数据
```

**Filter - 过滤器基类**
```python
class Filter(ABC):
    @abstractmethod
    def process(packet) -> packet  # 处理方法（子类实现）
    
    def execute(packet) -> packet  # 执行（含性能监控）
    def get_statistics()           # 获取统计信息
```

**Pipeline - 管道**
```python
class Pipeline:
    def add_filter(filter)     # 添加过滤器
    def start()                # 启动管道
    def stop()                 # 停止管道
    def put(packet)            # 输入数据
    def get() -> packet        # 获取输出
```

---

#### pipeline_config.py - 配置管理
**职责：** 集中管理所有配置

**配置类：**
- `CameraServiceConfig` - 相机配置
- `PreprocessServiceConfig` - 预处理配置
- `YOLOServiceConfig` - YOLO配置
- `OpenCVServiceConfig` - OpenCV配置
- `DisplayServiceConfig` - 显示配置
- `StorageServiceConfig` - 存储配置
- `LoggingConfig` - 日志配置

**预设配置：**
```python
PresetConfigs.development()    # 开发模式
PresetConfigs.production()     # 生产模式
PresetConfigs.debug()          # 调试模式
```

---

### 2. 微服务模块

#### services/camera_service.py - 相机服务
**职责：** 从工业相机采集图像

**主要功能：**
- 枚举设备
- 打开/关闭设备
- 开始/停止采集
- 获取图像帧

**关键方法：**
```python
def enumerate_devices()        # 枚举设备
def open_device(index)         # 打开设备
def start_grabbing()           # 开始采集
def process(packet) -> packet  # 采集图像
```

---

#### services/preprocess_service.py - 预处理服务
**职责：** 图像格式转换和增强

**主要功能：**
- 图像格式转换（Mono8 → BGR）
- 调整大小
- 降噪
- 锐化
- 亮度/对比度调整

---

#### services/yolo_service.py - YOLO检测服务
**职责：** 目标检测

**主要功能：**
- 加载YOLO模型（YOLOv5/YOLOv8）
- 目标检测
- 结果解析

**检测结果格式：**
```python
{
    'bbox': [x1, y1, x2, y2],
    'confidence': 0.95,
    'class_id': 0,
    'class_name': 'person'
}
```

---

#### services/opencv_service.py - OpenCV服务
**职责：** OpenCV图像处理

**主要功能：**
- 边缘检测（Canny）
- 轮廓检测
- 形态学操作
- 特征提取

---

#### services/display_service.py - 显示服务
**职责：** 实时显示处理结果

**主要功能：**
- 创建显示窗口
- 绘制检测框
- 显示FPS、帧号等信息
- 按键处理

---

#### services/storage_service.py - 存储服务
**职责：** 保存图像和检测结果

**主要功能：**
- 保存图像（JPG/PNG/BMP）
- 保存检测结果（JSON）
- 按条件保存（间隔/检测到目标）

---

### 3. 辅助模块

#### logger_config.py - 日志模块
**职责：** 统一日志管理

**日志文件：**
- `CameraApp_detail.log` - 详细日志
- `CameraApp_error.log` - 错误日志
- `CameraApp_daily.log` - 按日期轮转

---

## 🚀 使用方法

### 快速开始

#### 1. 基础运行

```bash
# 开发模式（默认）
python main.py

# 生产模式
python main.py --mode production

# 调试模式
python main.py --mode debug
```

#### 2. 自定义参数

```bash
# 设置相机参数
python main.py --exposure 15000 --gain 12.0 --frame-rate 25

# 设置YOLO参数
python main.py --yolo-model ./models/yolov8n.pt --confidence 0.6

# 禁用显示
python main.py --no-display

# 启用图像保存
python main.py --save-images
```

#### 3. 组合使用

```bash
# 生产模式 + 自定义参数 + 保存图像
python main.py --mode production \
               --exposure 12000 \
               --confidence 0.7 \
               --save-images \
               --no-display
```

---

### 命令行参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--mode` | 运行模式 | `--mode production` |
| `--exposure` | 曝光时间（μs） | `--exposure 15000` |
| `--gain` | 增益（dB） | `--gain 12.0` |
| `--frame-rate` | 帧率（fps） | `--frame-rate 25` |
| `--yolo-model` | YOLO模型路径 | `--yolo-model ./models/yolov8n.pt` |
| `--confidence` | 置信度阈值 | `--confidence 0.6` |
| `--no-display` | 禁用显示 | `--no-display` |
| `--save-images` | 启用图像保存 | `--save-images` |

---

## ⚙️ 配置说明

### 配置文件：pipeline_config.py

#### 1. 相机配置

```python
class CameraServiceConfig:
    exposure_time = 10000      # 曝光时间（微秒）
    gain = 10.0                # 增益（dB）
    frame_rate = 30.0          # 帧率（fps）
    trigger_mode = False       # 触发模式
    max_frames = 0             # 最大帧数（0=无限）
    buffer_size = 10           # 缓冲区大小
```

#### 2. YOLO配置

```python
class YOLOServiceConfig:
    model_path = "./models/yolov8n.pt"  # 模型路径
    device = "cpu"                       # 运行设备
    confidence_threshold = 0.5           # 置信度阈值
    iou_threshold = 0.45                 # NMS IOU阈值
```

#### 3. 显示配置

```python
class DisplayServiceConfig:
    window_name = "Vision Pipeline"
    show_fps = True            # 显示FPS
    show_detections = True     # 显示检测框
    display_fps_limit = 30     # 显示帧率限制
```

#### 4. 存储配置

```python
class StorageServiceConfig:
    save_images = True
    save_path = "./output/images"
    save_format = "jpg"
    save_on_detection = True   # 检测到目标时保存
```

---

### 运行模式

#### 开发模式（Development）
- 详细日志输出
- 启用实时显示
- 禁用图像保存
- 适合开发调试

#### 生产模式（Production）
- 精简日志输出
- 禁用实时显示
- 启用图像保存
- 适合实际部署

#### 调试模式（Debug）
- 最详细日志
- 限制采集帧数
- 启用性能监控
- 适合问题排查

---

## 🔧 开发指南

### 添加新的过滤器

#### 1. 创建过滤器类

```python
# services/my_service.py
from pipeline_core import Filter, DataPacket
from logger_config import get_logger

logger = get_logger("MyService")

class MyService(Filter):
    def __init__(self, config):
        super().__init__("MyService", config)
        # 初始化代码
    
    def process(self, packet: DataPacket) -> DataPacket:
        # 处理逻辑
        logger.info("处理数据包")
        return packet
```

#### 2. 添加配置

```python
# pipeline_config.py
class MyServiceConfig(ServiceConfig):
    def __init__(self):
        super().__init__("MyService", enabled=True)
        self.param1 = "value1"
        self.param2 = 100
```

#### 3. 注册到管道

```python
# scheduler.py
if self.config.my_service.enabled:
    my_service = MyService(self.config.my_service)
    self.pipeline.add_filter(my_service)
```

---

### 模块加载流程

```
1. main.py 启动
   ↓
2. 解析命令行参数
   ↓
3. 创建 VisionSystem
   ↓
4. 加载配置 (pipeline_config.py)
   ↓
5. 创建 PipelineScheduler
   ↓
6. 初始化各个服务
   ├─ CameraService
   ├─ PreprocessService
   ├─ YOLOService
   ├─ OpenCVService
   ├─ DisplayService
   └─ StorageService
   ↓
7. 创建 Pipeline
   ↓
8. 将服务添加到管道
   ↓
9. 启动管道
   ↓
10. 启动相机采集循环
    ↓
11. 数据流动
    相机 → 管道 → 各服务 → 输出
    ↓
12. 用户中断 (Ctrl+C)
    ↓
13. 停止管道
    ↓
14. 清理资源
    ↓
15. 退出
```

---

## 📊 性能监控

### 统计信息

系统会定期输出性能统计：

```
==================================================
管道统计: VisionPipeline
==================================================
运行状态: 运行中
输入队列: 2
输出队列: 1

过滤器统计:

  [PreprocessService]
    状态: 启用
    处理帧数: 1000
    错误次数: 0
    平均耗时: 5.23ms
    错误率: 0.00%

  [YOLOService]
    状态: 启用
    处理帧数: 1000
    错误次数: 2
    平均耗时: 45.67ms
    错误率: 0.20%
==================================================
```

---

## 📝 日志说明

### 日志文件

```
logs/
├── CameraApp_detail.log    # 所有日志（DEBUG级别）
├── CameraApp_error.log     # 仅错误日志
└── CameraApp_daily.log     # 按日期轮转
```

### 日志级别

- **DEBUG** - 详细调试信息
- **INFO** - 一般信息
- **WARNING** - 警告信息
- **ERROR** - 错误信息
- **CRITICAL** - 严重错误

---

## 🐛 故障排查

### 常见问题

#### 1. 找不到相机
**检查：**
- 相机是否连接
- 驱动是否安装
- 环境变量 `MVCAM_COMMON_RUNENV` 是否设置

#### 2. YOLO模型加载失败
**检查：**
- 模型文件是否存在
- ultralytics 是否安装：`pip install ultralytics`
- 模型格式是否正确（.pt 或 .onnx）

#### 3. 显示窗口无响应
**检查：**
- OpenCV 是否安装：`pip install opencv-python`
- 是否在无显示环境运行（使用 `--no-display`）

---

## 📦 依赖安装

```bash
# 基础依赖
pip install numpy opencv-python

# YOLO检测（可选）
pip install ultralytics

# 如果使用YOLOv5
pip install torch torchvision
```

---

## 🎉 总结

这是一个完整的、模块化的、可扩展的工业视觉系统：

✅ **管道-过滤器架构** - 清晰的数据流
✅ **微服务设计** - 独立的功能模块
✅ **配置化管理** - 灵活的参数配置
✅ **完整日志** - 详细的运行记录
✅ **性能监控** - 实时统计信息
✅ **易于扩展** - 添加新功能简单

**开始使用：**
```bash
python main.py
```

**查看帮助：**
```bash
python main.py --help
```

---

**版本：** 1.0.0  
**更新日期：** 2025-01-29  
**作者：** Kiro AI Assistant
