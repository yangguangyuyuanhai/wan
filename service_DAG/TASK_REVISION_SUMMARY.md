# 任务清单修订总结

## 修订日期
2026-01-29

## 修订原因
根据 `change_plus.md` 中专家的深度评审意见，对原任务清单进行重大调整。

---

## 🛑 关键修正（Critical Changes）

### 1. 执行模型战略调整
**原计划：** 先实现批处理模式（里程碑1），后实现流式模式（里程碑3）
**问题：** 工业视觉需要 30FPS+ 连续流处理，批处理模式会导致吞吐量极低
**修正：**
- ❌ **废弃** 任务 3.1（批处理模式执行器）
- ✅ **直接实现** 流式执行器（任务 4，提升至里程碑 1）
- ✅ 基于 asyncio.Queue 构建节点间连接
- ✅ 每个节点作为独立的长期运行任务

**影响：** 避免在错误的执行模型上浪费 8 小时，避免里程碑 3 的巨大返工

### 2. 类型系统缺失补充
**原计划：** 未明确类型系统实现任务
**问题：** 缺乏强类型检查会导致运行时数据格式错误
**修正：**
- ✅ **新增** 任务 1（基础数据类型系统）
- ✅ 定义 ImageType, BBoxType, DetectionListType 等
- ✅ 在端口定义中强制使用强类型
- ✅ 实现类型验证和兼容性检查

**影响：** 提前 3 小时，但避免后期难以调试的类型错误

### 3. 性能基准测试前置
**原计划：** 性能测试在里程碑 3 和里程碑 5
**问题：** 如果里程碑 3 才发现新架构比旧架构慢 50%，项目面临推倒重来
**修正：**
- ✅ **新增** 任务 6（性能基准测试，里程碑 1）
- ✅ 对比新旧版本的延迟和吞吐量
- ✅ **准入条件**：新版本性能不低于旧版本 90%
- ✅ 集成到 CI/CD 持续监控

**影响：** 提前 4 小时，但作为里程碑 1 的准入条件，降低重大风险

---

## ✅ 其他重要修正

### 4. 错误处理策略增强
**新增：**
- ✅ Restart Node 策略（相机卡死场景）
- ✅ initialize() 方法（用于节点重启）
- ✅ 更完善的错误恢复机制

### 5. 数据生命周期管理
**新增：**
- ✅ 引用计数机制（任务 4.6）
- ✅ input_data_processed_hook() 方法
- ✅ 明确的数据释放时机

### 6. 插件隔离性
**新增：**
- ✅ sys.path 保护（任务 5.3）
- ✅ 插件加载失败不影响主进程
- ✅ Sandbox 思想

### 7. 执行顺序调整
**原计划：** 按功能模块顺序（引擎 -> 插件 -> 性能 -> UI）
**修正：** 采用"核心先行，垂直打通"策略
- ✅ 里程碑 1：核心骨架（Core & Streaming Engine）
- ✅ 里程碑 2：最小闭环（Camera -> Display MVP）
- ✅ 里程碑 3：业务迁移与分支
- ✅ 里程碑 4：UI 集成

---

## 📊 工时调整对比

| 里程碑 | 原工时 | 新工时 | 变化 | 说明 |
|--------|--------|--------|------|------|
| 里程碑 1 | 32h | 44h | +12h | 新增类型系统、性能基准、流式执行器 |
| 里程碑 2 | 22h | 8h | -14h | 聚焦 MVP，仅 Camera + Display |
| 里程碑 3 | 21h | 22h | +1h | 业务插件迁移 + COW |
| 里程碑 4 | 25h | 25h | 0 | UI 集成不变 |
| 里程碑 5 | 14h | 14h | 0 | 测试文档不变 |
| **核心功能** | **75h** | **74h** | **-1h** | 更高效 |
| **完整系统** | **114h** | **113h** | **-1h** | 更合理 |

---

## 🎯 优先级调整

### Critical（必须在里程碑 1 完成）
- 类型系统（新增）
- 节点接口
- 图管理器
- **流式执行器**（从里程碑 3 提升）
- 插件管理器
- **性能基准**（从里程碑 5 提升）
- 启动入口

### Critical（必须在里程碑 2 完成）
- Camera 插件（从高提升）
- Display 插件（从中提升）
- MVP 测试

---

## 🚀 新的执行策略

### 阶段一：核心骨架（44小时）
**目标：** 验证流式执行模型的可行性和性能
**验证点：**
- Producer -> Consumer 测试图能运行
- 运行 1000 次循环，内存不增长
- 性能达到旧版本的 90% 以上

### 阶段二：最小闭环（8小时）
**目标：** 垂直打通，屏幕上看到相机画面
**验证点：**
- Camera -> Display 流程正常
- FPS 与 service_new 持平
- 运行 10 分钟无内存泄漏

### 阶段三：业务迁移（22小时）
**目标：** 完整功能迁移，支持分支和并行
**验证点：**
- 所有插件迁移完成
- COW 机制正确
- 并行分支性能提升

---

## 📝 专家评审意见摘要

> "不要先做'批处理'，直接做'流式'。工业视觉的核心是 30FPS+ 的连续流处理。如果先做批处理，你将在里程碑 3 遭遇巨大的返工痛苦。"

> "性能测试必须'左移'。在里程碑 1 完成时，必须建立一个基准测试。性能达标是进入里程碑 2 的准入条件。"

> "类型系统的缺失会导致运行时极易出现难以调试的数据格式错误。必须在里程碑 1 实现强类型系统。"

---

## ✅ 批准状态

**原状态：** 暂时不通过（需根据建议调整任务顺序）
**当前状态：** ✅ **已调整完成，可以开始实施**

---

## 下一步行动

1. **立即开始**：任务 1（实现基础数据类型系统）
2. **核心任务**：任务 4（实现流式执行器）⚠️ 最关键
3. **准入验证**：任务 6（性能基准测试）✅ 必须通过

**严格要求：** 每个里程碑必须通过验证点才能进入下一个里程碑。
