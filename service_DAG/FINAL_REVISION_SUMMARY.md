# 任务清单最终修订总结

## 修订日期
2026-01-29（最终版）

## 修订历程
1. **第一版**：基于需求文档和设计文档的初始任务清单
2. **第二版**：根据 change_plus.md 调整执行模型和优先级
3. **第三版（最终）**：根据 new_change.md 增加单机离线部署专项任务

---

## 🎯 核心场景定位

**业务场景：** 单机离线部署、无网络连接的工业视觉系统
**交付形式：** 绿色版软件包，客户电脑直接运行
**关键约束：**
- 不能依赖网络
- 不能假设客户有 Python 环境
- 必须支持插件热插拔
- 必须无人值守稳定运行

---

## 🛑 第三次修订的关键变更

### 1. PyInstaller 陷阱规避（Critical）

**问题：** PyInstaller 与动态插件架构"八字不合"
- PyInstaller 是静态编译，无法分析动态 import
- 打包后无法加载外部 .py 源码文件
- 丧失插件热插拔能力

**解决方案：** 采用嵌入式 Python（Embedded Python）
- ✅ **新增任务 21.1**：构建绿色版 Python 环境
- ✅ **新增任务 21.2**：依赖打包脚本
- ✅ **新增任务 21.3**：插件依赖检查工具
- ✅ **新增任务 21.4**：部署包构建

**优势：**
- 完美支持微内核架构
- plugins/ 文件夹直接放 .py 源码
- 现场工程师可以修改插件代码调试
- 给不同客户交付不同插件组合

### 2. GIL 瓶颈优化（Critical）

**问题：** Python GIL 锁导致单进程并发受限
- 相机采集（IO 密集）可能被算法（CPU 密集）阻塞
- 导致丢帧

**解决方案：** 严格使用 run_in_executor
- ✅ **修改任务 13.2**：YOLO 推理包裹在 run_in_executor
- ✅ **修改任务 14.2**：OpenCV 操作包裹在 run_in_executor
- ✅ **新增任务 24**：GIL 优化验证（4小时）

**验证：**
- 测试优化前后的 FPS 和延迟
- 确保相机采集不丢帧

### 3. 插件依赖管理增强（Critical）

**问题：** 客户电脑可能缺少依赖库
- 插件加载时 ImportError 导致程序崩溃
- 难以排查缺少哪些库

**解决方案：** 插件元数据增加依赖声明
- ✅ **修改任务 5.1**：安全加载模式（捕获 ImportError）
- ✅ **修改任务 5.2**：dependencies 字段验证
- ✅ **新增任务 21.3**：依赖检查工具

**示例：**
```python
__plugin_metadata__ = {
    'type': 'yolo_v8',
    'name': 'YOLO目标检测',
    'dependencies': ['ultralytics', 'torch', 'opencv-python']
}
```

### 4. 磁盘空间管理（High）

**问题：** 单机环境硬盘写满导致系统崩溃
- 连续运行一个月后硬盘满
- 日志文件无限增长

**解决方案：** 磁盘空间监控和循环覆盖
- ✅ **修改任务 12.2**：ImageWriter 磁盘空间监控
- ✅ **新增任务 23**：磁盘空间管理增强（2小时）

**功能：**
- 定期检查磁盘剩余空间
- 低空间时停止写入或循环覆盖
- 日志文件轮转和自动清理

### 5. 进程守护和自启动（High）

**问题：** 无人值守环境需要自动恢复
- 程序崩溃无人处理
- 需要开机自启动

**解决方案：** 守护进程和健康检查
- ✅ **新增任务 22**：进程守护和自启动（3小时）

**功能：**
- 守护脚本检测主程序状态
- 崩溃时自动重启
- 心跳健康检查
- 开机自启动配置

---

## 📊 工时变化对比

| 类别 | 第二版 | 第三版（最终） | 变化 |
|------|--------|---------------|------|
| 里程碑 1 | 44h | 44h | 0 |
| 里程碑 2 | 8h | 8h | 0 |
| 里程碑 3 | 22h | 24h | +2h（GIL优化） |
| 里程碑 4 | 25h | 25h | 0 |
| 里程碑 5 | 14h | 14h | 0 |
| **部署专项** | **0** | **17h** | **+17h（新增）** |
| 附加任务 | 16h | 16h | 0 |
| **核心功能** | **74h** | **76h** | **+2h** |
| **生产就绪** | **-** | **93h** | **新增** |
| **完整系统** | **113h** | **132h** | **+19h** |

**关键变化：**
- 核心功能仅增加 2 小时（GIL 优化）
- 新增 17 小时的部署专项任务
- 生产就绪总计 93 小时（包含部署）

---

## 🎯 新增任务清单

### 任务 21：单机离线部署打包（8小时）
- 21.1 嵌入式 Python 环境构建
- 21.2 依赖打包脚本
- 21.3 插件依赖检查工具
- 21.4 部署包构建

### 任务 22：进程守护和自启动（3小时）
- 22.1 创建守护进程脚本
- 22.2 开机自启动配置
- 22.3 健康检查机制

### 任务 23：磁盘空间管理增强（2小时）
- 23.1 全局磁盘监控
- 23.2 ImageWriter 循环覆盖
- 23.3 日志文件管理

### 任务 24：GIL 优化验证（4小时）
- 24.1 识别 CPU 密集节点
- 24.2 实现 run_in_executor 包裹
- 24.3 性能对比测试

---

## 🏗️ 部署架构对比

### 方案 A：PyInstaller（不推荐）
```
myapp.exe (100MB)
├── python39.dll
├── 所有依赖库（打包进去）
└── 插件（打包进去，无法修改）
```

**问题：**
- ❌ 无法动态加载外部插件
- ❌ 无法热插拔
- ❌ 现场无法调试

### 方案 B：嵌入式 Python（推荐）
```
MyVisionApp/
├── python/                    # 绿色版 Python
│   ├── python.exe
│   ├── python39.dll
│   └── Lib/
├── libs/                      # 依赖库
│   ├── numpy/
│   ├── opencv/
│   └── ultralytics/
├── service_DAG/               # 主程序
│   ├── main_dag.py
│   ├── core/
│   └── engine/
├── plugins/                   # 插件（可修改）
│   ├── basic/
│   │   ├── camera_hik.py
│   │   └── image_save.py
│   └── algo/
│       ├── yolo_infer.py
│       └── opencv_proc.py
├── config/                    # 配置
│   └── pipeline.json
├── start.bat                  # 启动脚本
└── watchdog.bat               # 守护脚本
```

**优势：**
- ✅ 完美支持动态插件
- ✅ 支持热插拔
- ✅ 现场可调试
- ✅ 不同客户不同插件组合

---

## 📝 专家评审意见摘要（new_change.md）

> "架构设计极其先进，但'落地交付'环节存在两个隐蔽的'深坑'。"

> "PyInstaller 与动态插件的'八字不合'。打包后无法加载外部 .py 源码文件。"

> "单进程并发的'GIL 瓶颈'。相机采图线程可能会被算法线程阻塞，导致丢帧。"

> "传统的微服务（Docker/K8s）在单机无网环境下是累赘，而你设计的'进程内微服务（Microkernel）'正是这种场景下的终极解决方案。"

> "只要搞定'嵌入式 Python 环境'的打包问题，这套架构将成为你极具竞争力的技术资产。"

---

## ✅ 批准状态

**第一版：** 暂时不通过（需调整执行模型）
**第二版：** 已调整完成（需补充部署方案）
**第三版（最终）：** ✅ **完全通过，可以开始实施**

---

## 🚀 最终执行路线图

### 阶段 1：核心骨架（44小时）
**目标：** 验证流式执行模型
**关键任务：** 类型系统、流式执行器、性能基准

### 阶段 2：最小闭环（8小时）
**目标：** Camera -> Display 垂直打通
**关键任务：** Camera 插件、Display 插件

### 阶段 3：业务迁移（24小时）
**目标：** 完整功能 + GIL 优化
**关键任务：** YOLO、OpenCV、Storage、COW

### 阶段 4：生产部署（17小时）
**目标：** 单机离线可交付
**关键任务：** 嵌入式 Python、守护进程、磁盘管理、GIL 验证

### 阶段 5：UI 和文档（39小时）
**目标：** 完整产品
**关键任务：** Qt 集成、可视化编辑器、文档

---

## 🎖️ 技术亮点总结

这套架构的核心价值：

1. **开发效率**：模块解耦，多人协作不打架
2. **运行效率**：零拷贝，单进程，榨干硬件性能
3. **交付效率**：增删 plugins 文件夹，给不同客户交付不同功能
4. **维护效率**：现场工程师可以修改插件代码调试
5. **竞争优势**：类似 VisionMaster 的工业级架构

**这是一套真正适合单机离线工业场景的"进程内微服务"架构。**

---

## 下一步行动

1. **立即开始**：任务 1（实现基础数据类型系统）
2. **核心任务**：任务 4（实现流式执行器）⚠️ 最关键
3. **准入验证**：任务 6（性能基准测试）✅ 必须通过
4. **部署关键**：任务 21（嵌入式 Python 环境）⚠️ 生产必需

**严格要求：** 每个里程碑必须通过验证点才能进入下一个里程碑。
